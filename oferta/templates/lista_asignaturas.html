{% extends 'base.html' %}
{% load static %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 gap-4">
    
    <h1 class="text-3xl font-bold text-white">
        Oferta académica
        {% if request.GET.sede %}
            <span class="text-2xl font-normal text-gray-400"> - {{ request.GET.sede }}</span>
        {% else %}
            <span class="text-2xl font-normal text-gray-400"> - (Sin sede seleccionada)</span>
        {% endif %}
    </h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-6">

    <div class="lg:col-span-9 space-y-6"> 
        
        <div class="bg-gray-900/50 backdrop-blur-sm rounded-2xl border border-gray-700/50 shadow-xl">
            <div class="p-6">
                
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-lg font-semibold text-white flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                        Filtros de Búsqueda
                    </h3>
                    
                    <button id="toggle-filtros-btn" class="md:hidden p-2 bg-gray-700/50 hover:bg-gray-700 rounded-lg text-gray-300 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                        </svg>
                    </button>
                </div>
                
                {% include "includes/filtros.html" %}
            </div>
        </div>
        
        <div class="bg-gray-900/50 backdrop-blur-sm rounded-2xl border border-gray-700/50 shadow-xl overflow-hidden">
            {% include "includes/tabla_asignaturas.html" %}
        </div>
    
        <nav class="mt-6 flex flex-wrap justify-center items-center gap-3">
            {% if asignaturas.has_previous %}
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ asignaturas.previous_page_number }}"
                class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 hover:border-gray-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </a>
            {% else %}
                <span class="px-4 py-2 bg-gray-800/50 text-gray-500 rounded-lg cursor-not-allowed border border-gray-700/50 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </span>
            {% endif %}

            <span class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium border border-blue-500/50">
                Página {{ asignaturas.number }} de {{ asignaturas.paginator.num_pages }}
            </span>

            {% if asignaturas.has_next %}
                <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ asignaturas.next_page_number }}"
                class="px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors border border-gray-700 hover:border-gray-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </a>
            {% else %}
                <span class="px-4 py-2 bg-gray-800/50 text-gray-500 rounded-lg cursor-not-allowed border border-gray-700/50 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                    </svg>
                </span>
            {% endif %}
        </nav>
        </div>

    <div class="lg:col-span-3">
        <div class="lg:sticky lg:top-6">
            <div id="seleccionadas-container">
                </div>
        </div>
    </div>

</div> 


<div id="horario" class="mt-8 mb-4">
</div>

{% if user.is_authenticated %}
<div class="mb-8 bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">Mis Horarios Guardados</h2>
        <button id="btn-guardar-horario" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
            </svg>
            Guardar Horario
        </button>
    </div>
    <div id="horarios-guardados-container" class="flex flex-wrap gap-2">
        <p class="text-gray-400 text-sm italic">Cargando...</p>
    </div>
</div>
{% else %}
<div class="mb-8 bg-gray-800 rounded-lg p-6 border border-yellow-700/50">
    <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
        </svg>
        <div>
            <p class="text-white font-medium">¿Quieres guardar tus horarios?</p>
            <p class="text-gray-400 text-sm">
                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="text-blue-400 hover:text-blue-300 underline">Inicia sesión</a> o 
                <a href="{% url 'registro' %}?next={{ request.get_full_path|urlencode }}" class="text-blue-400 hover:text-blue-300 underline">regístrate</a> para guardar y gestionar múltiples horarios.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4 mb-4 flex flex-col sm:flex-row sm:justify-start gap-3">
    <button onclick="exportarComoICS()" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500">
        Exportar a Google Calendar (.ics)
    </button>
    <button onclick="exportarComoPDF()" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded">
        Exportar como PDF
    </button>
</div>

{% include "includes/modales.html" %}

<script type="module" src="{% static 'js/main.js' %}"></script>
<script type="module">
    import { initGeneradorModal, abrirModalGenerador } from '{% static "js/generadorModal.js" %}';
    
    document.addEventListener('DOMContentLoaded', () => {
        initGeneradorModal();
        
        const btnAbrirGenerador = document.getElementById('btn-abrir-generador');
        if (btnAbrirGenerador) {
            btnAbrirGenerador.addEventListener('click', abrirModalGenerador);
        }
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    function resetDependientes(campoCambiado) {
        // ... (Tu función existente, no necesita cambios)
        const form = document.getElementById('filtros-form'); 
        if (!form) return; 
        if (campoCambiado === 'sede') {
            if (form.carrera) form.carrera.value = '';
            if (form.jornada) form.jornada.value = '';
            if (form.nivel) form.nivel.value = '';
            if (form.busqueda) form.busqueda.value = '';
        }
        if (['carrera', 'nivel'].includes(campoCambiado)) {
            if (form.busqueda) form.busqueda.value = '';
        }
        form.submit();
    }
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- NUEVO: JS para el toggle de filtros en móvil ---
    const toggleBtn = document.getElementById('toggle-filtros-btn');
    const filtrosForm = document.getElementById('filtros-form'); // El <form> en sí
    
    if (toggleBtn && filtrosForm) {
        toggleBtn.addEventListener('click', function() {
            // 'hidden' es la clase que oculta el formulario en móvil
            filtrosForm.classList.toggle('hidden');
            
            // Opcional: cambiar la apariencia del botón para indicar que está activo
            if (filtrosForm.classList.contains('hidden')) {
                toggleBtn.classList.remove('bg-blue-600/20', 'text-blue-300');
            } else {
                toggleBtn.classList.add('bg-blue-600/20', 'text-blue-300');
            }
        });
    }

    // --- JS para paginación responsive (el que implementamos antes) ---
    const urlParams = new URLSearchParams(window.location.search);
    const currentPerPage = urlParams.get('per_page');
    
    let desiredPerPage = 5; // Default (móvil/tableta)
    if (window.innerWidth >= 1024) {
        desiredPerPage = 8; // Desktop
    }
    
    if (String(currentPerPage) !== String(desiredPerPage)) {
        urlParams.set('per_page', desiredPerPage);
        window.location.search = urlParams.toString();
    }
});
</script>

{% endblock %}