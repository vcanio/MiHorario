{% extends 'base.html' %}
{% load static %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<h1 class="text-3xl font-bold mb-6">
    Oferta académica
    {% if request.GET.sede %}
        <span class="text-2xl font-normal text-gray-400"> - {{ request.GET.sede }}</span>
    {% else %}
        <span class="text-2xl font-normal text-gray-400"> - (Sin sede seleccionada)</span>
    {% endif %}
</h1>

{% include "includes/filtros.html" %}
{% include "includes/tabla_asignaturas.html" %}

<nav class="mt-6 flex flex-wrap justify-center items-center gap-2 text-sm">
    {% if asignaturas.has_previous %}
        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ asignaturas.previous_page_number }}"
        class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-600">
            &laquo; Anterior
        </a>
    {% else %}
        <span class="px-3 py-1 bg-gray-800 text-gray-500 rounded cursor-not-allowed">
            &laquo; Anterior
        </span>
    {% endif %}

    <span class="px-3 py-1 bg-gray-800 text-gray-300 rounded">
        Página {{ asignaturas.number }} de {{ asignaturas.paginator.num_pages }}
    </span>

    {% if asignaturas.has_next %}
        <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ asignaturas.next_page_number }}"
        class="px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-600">
            Siguiente &raquo;
        </a>
    {% else %}
        <span class="px-3 py-1 bg-gray-800 text-gray-500 rounded cursor-not-allowed">
            Siguiente &raquo;
        </span>
    {% endif %}
</nav>

<div id="horario" class="mt-4 mb-4"></div>

<!-- NUEVA SECCIÓN: Horarios Guardados -->
{% if user.is_authenticated %}
<div class="mb-8 bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-white">Mis Horarios Guardados</h2>
        <button id="btn-guardar-horario" 
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
            </svg>
            Guardar Horario
        </button>
    </div>
    <div id="horarios-guardados-container" class="flex flex-wrap gap-2">
        <p class="text-gray-400 text-sm italic">Cargando...</p>
    </div>
</div>
{% else %}
<div class="mb-8 bg-gray-800 rounded-lg p-6 border border-yellow-700/50">
    <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-yellow-500">
            <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
        </svg>
        <div>
            <p class="text-white font-medium">¿Quieres guardar tus horarios?</p>
            <p class="text-gray-400 text-sm">
                <a href="{% url 'login' %}" class="text-blue-400 hover:text-blue-300 underline">Inicia sesión</a> o 
                <a href="{% url 'registro' %}" class="text-blue-400 hover:text-blue-300 underline">regístrate</a> para guardar y gestionar múltiples horarios.
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4 mb-4 flex flex-col sm:flex-row sm:justify-start gap-3">
    <button onclick="exportarComoICS()" class="w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded hover:bg-green-500">
    Exportar a Google Calendar (.ics)
    </button>
    <button onclick="exportarComoPDF()" class="w-full sm:w-auto px-4 py-2 bg-blue-600 text-white rounded">
    Exportar como PDF
    </button>
</div>

<div id="modal-solapamiento" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden">
    <div class="relative w-full max-w-md p-6 bg-gray-800 rounded-lg shadow-xl border border-gray-700">
        
        <div class="flex items-center justify-center mb-4">
            <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-900 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                </svg>
            </div>
        </div>
        
        <h3 id="modal-titulo" class="text-lg font-semibold text-center text-white mb-2">
            Conflicto de Horario
        </h3>
        <p id="modal-mensaje" class="text-sm text-center text-gray-300 mb-6">
            El mensaje de error irá aquí.
        </p>

        <div class="text-center">
            <button id="modal-btn-cerrar" type="button" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-gray-800">
                Entendido
            </button>
        </div>
    </div>
</div>
<div id="modal-confirmacion" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75 hidden">
    <div class="relative w-full max-w-md p-6 bg-gray-800 rounded-lg shadow-xl border border-gray-700">
        
        <div class="flex items-center justify-center mb-4">
            <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-900 sm:mx-0 sm:h-10 sm:w-10">
                <svg class="h-6 w-6 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
                </svg>
            </div>
        </div>
        
        <h3 id="confirm-modal-titulo" class="text-lg font-semibold text-center text-white mb-2">
            Confirmar Reemplazo
        </h3>
        <p id="confirm-modal-mensaje" class="text-sm text-center text-gray-300 mb-6">
            El mensaje de confirmación irá aquí.
        </p>

        <div class="flex flex-col-reverse sm:flex-row sm:justify-center sm:gap-4">
            <button id="confirm-modal-btn-cancelar" type="button" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-gray-600 shadow-sm px-6 py-2 bg-gray-700 text-base font-medium text-white hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 focus:ring-offset-gray-800 mt-3 sm:mt-0">
                Cancelar
            </button>
            <button id="confirm-modal-btn-aceptar" type="button" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent shadow-sm px-6 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-gray-800">
                Reemplazar
            </button>
        </div>
    </div>
</div>

<script type="module" src="{% static 'js/main.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    function resetDependientes(campoCambiado) {
        // 1. Usamos la ID del formulario para evitar errores
        const form = document.getElementById('filtros-form'); 
        
        if (!form) return; // Parar si no se encuentra el formulario

        // 2. Si el usuario cambia la SEDE, reseteamos TODOS los demás filtros
        if (campoCambiado === 'sede') {
            if (form.carrera) form.carrera.value = '';
            if (form.jornada) form.jornada.value = '';
            if (form.nivel) form.nivel.value = '';
            if (form.busqueda) form.busqueda.value = '';
        }
        
        // 3. Si el usuario cambia CARRERA o NIVEL, reseteamos solo el filtro de asignatura
        if (['carrera', 'nivel'].includes(campoCambiado)) {
            if (form.busqueda) form.busqueda.value = '';
        }

        // 4. Enviamos el formulario. Ahora incluirá el valor de "sede"
        // (ya que es un campo más del formulario) junto con el campo cambiado.
        form.submit();
    }
</script>
{% endblock %}